version: '3.8'

# ============================================
# DEVELOPMENT ENVIRONMENT - Lightweight
# Môi trường phát triển nhẹ cho localhost
# ============================================
# Chạy: docker-compose -f docker-compose.dev.yml up -d
# Dừng: docker-compose -f docker-compose.dev.yml down

services:
  # Landing Page - Marketing Site
  landing:
    build:
      context: ./apps/landing
      dockerfile: Dockerfile
      target: development
    container_name: ${PROJECT_NAME}-landing-dev
    ports:
      - "${LANDING_PORT}:3008"
    volumes:
      - ./apps/landing:/app
      - /app/node_modules
      - /app/.next
    environment:
      - NODE_ENV=development
      - NEXT_PUBLIC_API_BASE_URL=${BACKEND_URL}
      - NEXT_PUBLIC_BACKEND_URL=${BACKEND_URL}
      - NEXT_PUBLIC_DOCS_URL=${DOCS_URL}
      - NEXT_PUBLIC_DEMO_STORE_1_URL=${DEMO_STORE_1_URL}
      - NEXT_PUBLIC_DEMO_STORE_2_URL=${DEMO_STORE_2_URL}
    networks:
      - dev-network
    restart: unless-stopped

  # Frontend - Next.js Storefront
  frontend:
    build:
      context: ./apps/storefront
      dockerfile: Dockerfile
      target: development
    container_name: ${PROJECT_NAME}-storefront-dev
    ports:
      - "${STOREFRONT_PORT}:3009"
    volumes:
      - ./apps/storefront:/app
      - /app/node_modules
      - /app/.next
    environment:
      - NODE_ENV=development
      - STOREFRONT_PORT=3009
      - BACKEND_API_URL=http://backend:80
      - NEXT_PUBLIC_API_URL=${BACKEND_URL}/api
      - NEXT_PUBLIC_APP_URL=${STOREFRONT_URL}
    depends_on:
      - backend
    networks:
      - dev-network
    restart: unless-stopped

  # Backend - Laravel Application
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
      target: development
    container_name: ${PROJECT_NAME}-backend-dev
    ports:
      - "${BACKEND_PORT}:80"
      - "${VITE_PORT}:${VITE_PORT}"
    volumes:
      - ./backend:/var/www/html
    environment:
      - APP_ENV=local
      - APP_DEBUG=true
      - DB_CONNECTION=mysql
      - DB_HOST=mysql
      - DB_PORT=3306
      - DB_DATABASE=${DB_DATABASE}
      - DB_USERNAME=${DB_USERNAME}
      - DB_PASSWORD=${DB_PASSWORD}
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - MAIL_MAILER=smtp
      - MAIL_HOST=mailhog
      - MAIL_PORT=1025
    depends_on:
      - mysql
      - redis
    networks:
      - dev-network
    restart: unless-stopped

  # MySQL Database
  mysql:
    image: mysql:8.0
    container_name: ${PROJECT_NAME}-mysql-dev
    ports:
      - "${MYSQL_PORT}:3306"
    environment:
      MYSQL_ROOT_PASSWORD: ${DB_ROOT_PASSWORD}
      MYSQL_DATABASE: ${DB_DATABASE}
      MYSQL_USER: ${DB_USERNAME}
      MYSQL_PASSWORD: ${DB_PASSWORD}
    volumes:
      - mysql-dev-data:/var/lib/mysql
    command: --default-authentication-plugin=mysql_native_password
    networks:
      - dev-network
    restart: unless-stopped

  # Redis Cache
  redis:
    image: redis:7-alpine
    container_name: ${PROJECT_NAME}-redis-dev
    ports:
      - "${REDIS_PORT}:6379"
    volumes:
      - redis-dev-data:/data
    networks:
      - dev-network
    restart: unless-stopped

  # MailHog (for email testing)
  mailhog:
    image: mailhog/mailhog:latest
    container_name: ${PROJECT_NAME}-mailhog-dev
    ports:
      - "${MAILHOG_SMTP_PORT}:1025"
      - "${MAILHOG_WEB_PORT}:8025"
    networks:
      - dev-network
    restart: unless-stopped

networks:
  dev-network:
    driver: bridge

volumes:
  mysql-dev-data:
    driver: local
  redis-dev-data:
    driver: local
